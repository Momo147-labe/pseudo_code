name: Build Windows Installer

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ R√©cup√©rer le code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Installer Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # 3Ô∏è‚É£ Activer le support Windows
      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      # 4Ô∏è‚É£ Installer les d√©pendances
      - name: Install dependencies
        run: flutter pub get

        # 5Ô∏è‚É£ Supprimer les builds pr√©c√©dents
      - name: Nettoyer l'ancienne build
        run: flutter clean
  

      # 5Ô∏è‚É£ Build Windows Release
      - name: Build Windows EXE
        run: flutter build windows --release

      # 6Ô∏è‚É£ V√©rifier que le dossier Release existe
      - name: Verify build output
        shell: pwsh
        run: |
          if (!(Test-Path "build/windows/x64/runner/Release")) {
            Write-Error "‚ùå Dossier Release introuvable"
            exit 1
          }
          Get-ChildItem build/windows/x64/runner/Release
      # 7Ô∏è‚É£ D√©tecter le .exe
      - name: Get EXE name
        shell: pwsh
        run: |
          $exe = Get-ChildItem build/windows/x64/runner/Release/*.exe | Select-Object -First 1
          if (-not $exe) {
            Write-Error "‚ùå Aucun EXE trouv√©"
            exit 1
          }
          echo "EXE_NAME=$($exe.Name)" >> $env:GITHUB_ENV
          echo "‚úî EXE trouv√© : $($exe.Name)"
      # 8Ô∏è‚É£ Installer Inno Setup via Chocolatey
      - name: Install Inno Setup
        run: choco install innosetup -y

      # 9Ô∏è‚É£ V√©rifier que le fichier installer.iss existe
      - name: Verify installer.iss exists
        shell: pwsh
        run: |
          if (!(Test-Path "installer.iss")) {
            Write-Error "‚ùå installer.iss introuvable !"
            exit 1
          }
          Write-Host "‚úî installer.iss trouv√©"
      # üîü G√©n√©rer Setup.exe avec le chemin complet de ISCC
      - name: Build Setup.exe with Inno Setup
        shell: pwsh
        run: |
          mkdir Output -Force
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer.iss"
      # 1Ô∏è‚É£1Ô∏è‚É£ Upload du Setup.exe comme artifact
      - name: Upload Setup.exe
        uses: actions/upload-artifact@v4
        with:
          name: windows-setup
          path: Output/*.exe